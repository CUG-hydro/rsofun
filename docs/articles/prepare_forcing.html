<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prepare rsofun forcing • rsofun</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Prepare rsofun forcing">
<meta property="og:description" content="rsofun">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rsofun</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/pmodel_use.html">P-model usage</a>
    </li>
    <li>
      <a href="../articles/prepare_forcing.html">Prepare rsofun forcing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/computationales/rsofun/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="prepare_forcing_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Prepare rsofun forcing</h1>
                        <h4 class="author">Beni Stocker</h4>
            
            <h4 class="date">2021-11-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/computationales/rsofun/blob/master/vignettes/prepare_forcing.Rmd"><code>vignettes/prepare_forcing.Rmd</code></a></small>
      <div class="hidden name"><code>prepare_forcing.Rmd</code></div>

    </div>

    
    
<div id="prepare-forcing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-forcing-data" class="anchor"></a>Prepare forcing data</h2>
<p>ALL BELOW IS COPIED FROM sofunCalVal/data/00_prepare_fluxnet_driver_data.R</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>
  collapse <span class="op">=</span> <span class="cn">TRUE</span>,
  comment <span class="op">=</span> <span class="st">"#&gt;"</span>
<span class="op">)</span>

<span class="co"># Routine to format the benchmark driver dataset</span>
<span class="co"># based upon FLUXNET data. This routine assumes</span>
<span class="co"># that the code is run on th Euler compute</span>
<span class="co"># infrastructure</span>
<span class="co">#</span>
<span class="co"># The data generated is meant to drive the p-model</span>
<span class="co"># and provide a good working / test dataset.</span>
<span class="co"># The routine used is largely based on previous work</span>
<span class="co"># REFERENCE PAPER BENI.</span>

<span class="co"># Libraries, check for Euler access ----</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>## ✓ ggplot2 3.3.5     ✓ purrr   0.3.4
## ✓ tibble  3.1.5     ✓ dplyr   1.0.7
## ✓ tidyr   1.1.4     ✓ stringr 1.4.0
## ✓ readr   2.0.2     ✓ forcats 0.5.1</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/computationales/rsofun">rsofun</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/computationales/ingestr">ingestr</a></span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Attaching package: 'ingestr'</code></pre>
<pre><code>## The following object is masked from 'package:rsofun':
## 
##     init_dates_dataframe</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># if(!grepl('eu-', Sys.info()['nodename'])){</span>
<span class="co">#   stop("You are not on Euler, source data unavailable - abort abort abort!")</span>
<span class="co"># }</span>

<span class="co"># . set sites to ingest ----</span>
<span class="va">fluxnet_sites</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ingestr/man/siteinfo_fluxnet2015.html">siteinfo_fluxnet2015</a></span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="co"># just an example</span>

<span class="co"># . grab fluxnet data ----</span>
<span class="va">df_fluxnet</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span>
      <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
        siteinfo  <span class="op">=</span> <span class="va">fluxnet_sites</span>,
        source    <span class="op">=</span> <span class="st">"fluxnet"</span>,
        getvars   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
          temp <span class="op">=</span> <span class="st">"TA_F_DAY"</span>,
          prec <span class="op">=</span> <span class="st">"P_F"</span>,
          vpd  <span class="op">=</span> <span class="st">"VPD_F_DAY"</span>,
          ppfd <span class="op">=</span> <span class="st">"SW_IN_F"</span>,
          patm <span class="op">=</span> <span class="st">"PA_F"</span><span class="op">)</span>,
        dir       <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/DD/"</span>,
        settings  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
          dir_hh <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/HH/"</span>, getswc <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
        timescale <span class="op">=</span> <span class="st">"d"</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="co"># . get CRU data to complement fluxnet data ----</span>
<span class="va">df_cru</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo  <span class="op">=</span> <span class="va">fluxnet_sites</span>,
  source    <span class="op">=</span> <span class="st">"cru"</span>,
  getvars   <span class="op">=</span> <span class="st">"ccov"</span>,
  dir       <span class="op">=</span> <span class="st">"~/data/cru/ts_4.01/"</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## Loading required namespace: ncdf4</code></pre>
<pre><code>## Warning in .varName(nc, varname, warn = warn): varname used is: cld
## If that is not correct, you can set it to one of: cld, stn</code></pre>
<pre><code>## Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if `.name_repair` is omitted as of tibble 2.0.0.
## Using compatibility `.name_repair`.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># . merge data into one "meteo" data frame ----</span>
<span class="va">df_meteo</span> <span class="op">&lt;-</span> <span class="va">df_fluxnet</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">df_cru</span> <span class="op">%&gt;%</span>
      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sitename"</span>, <span class="st">"date"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># . grab MODIS FPAR data ----</span>
<span class="va">settings_modis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/get_settings_modis.html">get_settings_modis</a></span><span class="op">(</span>
  bundle            <span class="op">=</span> <span class="st">"modis_fpar"</span>,
  data_path         <span class="op">=</span> <span class="st">"~/data/modis_subsets/"</span>,
  method_interpol   <span class="op">=</span> <span class="st">"loess"</span>,
  network <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fluxnet"</span>,<span class="st">"icos"</span><span class="op">)</span>,
  keep              <span class="op">=</span> <span class="cn">TRUE</span>,
  overwrite_raw     <span class="op">=</span> <span class="cn">FALSE</span>,
  overwrite_interpol<span class="op">=</span> <span class="cn">TRUE</span>,
  n_focal           <span class="op">=</span> <span class="fl">0</span>
  <span class="op">)</span>

<span class="va">df_modis_fpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  <span class="va">fluxnet_sites</span>,
  source <span class="op">=</span> <span class="st">"modis"</span>,
  settings <span class="op">=</span> <span class="va">settings_modis</span>,
  parallel <span class="op">=</span> <span class="cn">FALSE</span>,
  ncores <span class="op">=</span> <span class="fl">1</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## Number of available pixels:  289</code></pre>
<pre><code>## Averaging across number of pixels:  1</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Warning: The `path` argument of `write_csv()` is deprecated as of readr 1.4.0.
## Please use the `file` argument instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<pre><code>## Number of available pixels:  289</code></pre>
<pre><code>## Averaging across number of pixels:  1</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Number of available pixels:  289</code></pre>
<pre><code>## Averaging across number of pixels:  1</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## renaming the variable</span>
<span class="va">df_modis_fpar</span> <span class="op">&lt;-</span> <span class="va">df_modis_fpar</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="va">.</span>, fapar <span class="op">=</span> <span class="va">modisvar_filled</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>

<span class="co"># . grab CO2 data ----</span>
<span class="va">df_co2</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  <span class="va">fluxnet_sites</span>,
  source  <span class="op">=</span> <span class="st">"co2_mlo"</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## [1] "ftp://aftp.cmdl.noaa.gov/products/trends/co2/co2_mm_mlo.txt"</code></pre>
<pre><code>## /var/folders/f_/vvrf3z593z7_hnkqmjt6rwtw0000gq/T//RtmpJ2wr1P/filec41477fd642e</code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># . set soil parameters ----</span>
<span class="va">df_soiltexture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  top    <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
    layer <span class="op">=</span> <span class="st">"top"</span>,
    fsand <span class="op">=</span> <span class="fl">0.4</span>,
    fclay <span class="op">=</span> <span class="fl">0.3</span>,
    forg <span class="op">=</span> <span class="fl">0.1</span>,
    fgravel <span class="op">=</span> <span class="fl">0.1</span>
    <span class="op">)</span>,
  bottom <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
    layer <span class="op">=</span> <span class="st">"bottom"</span>,
    fsand <span class="op">=</span> <span class="fl">0.4</span>,
    fclay <span class="op">=</span> <span class="fl">0.3</span>,
    forg <span class="op">=</span> <span class="fl">0.1</span>,
    fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="run-model" class="section level2">
<h2 class="hasAnchor">
<a href="#run-model" class="anchor"></a>Run model</h2>
<p>set simulation parameters</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_siml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  spinup             <span class="op">=</span> <span class="cn">TRUE</span>,
  spinupyears        <span class="op">=</span> <span class="fl">10</span>,
  recycle            <span class="op">=</span> <span class="fl">1</span>,
  soilmstress        <span class="op">=</span> <span class="cn">TRUE</span>,
  tempstress         <span class="op">=</span> <span class="cn">TRUE</span>,
  calc_aet_fapar_vpd <span class="op">=</span> <span class="cn">FALSE</span>,
  in_ppfd            <span class="op">=</span> <span class="cn">TRUE</span>,
  in_netrad          <span class="op">=</span> <span class="cn">FALSE</span>,
  outdt              <span class="op">=</span> <span class="fl">1</span>,
  ltre               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltne               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltrd               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltnd               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr3               <span class="op">=</span> <span class="cn">TRUE</span>,
  lgn3               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr4               <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span></code></pre></div>
<p>combine all data into the rsofun driver data format and save locally</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_model_fluxnet_drivers</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="fu"><a href="../reference/collect_drivers_sofun.html">collect_drivers_sofun</a></span><span class="op">(</span>
  site_info      <span class="op">=</span> <span class="va">fluxnet_sites</span>,
  params_siml    <span class="op">=</span> <span class="va">params_siml</span>,
  meteo          <span class="op">=</span> <span class="va">df_meteo</span>,
  fapar          <span class="op">=</span> <span class="va">df_modis_fpar</span>,
  co2            <span class="op">=</span> <span class="va">df_co2</span>,
  params_soil    <span class="op">=</span> <span class="va">df_soiltexture</span>
  <span class="op">)</span>
<span class="co">#&gt; Warning: Variable 'snow' missing in meteo data frame. </span>
<span class="co">#&gt;                 Assuming zero for all dates.</span>
<span class="co">#&gt; Warning: Variable 'rain' missing in meteo data frame.</span>
<span class="co">#&gt;                 Assuming equal to 'prec' for all dates.</span>
<span class="co">#&gt; Warning: Variable 'tmin' missing in meteo data frame.</span>
<span class="co">#&gt;                 Assuming equal to 'temp' for all dates.</span>
<span class="co">#&gt;                 (same goes for tmax as assumed paired)</span>

<span class="co"># . save data as a datafile, recognized by the package ----</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">p_model_fluxnet_drivers</span>,
     file <span class="op">=</span> <span class="st">"~/trash/p_model_fluxnet_drivers.rda"</span>,
     compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></code></pre></div>
</div>
<div id="prepare-validation-data" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-validation-data" class="anchor"></a>Prepare validation data</h2>
<p>Ingest GPP data from FLUXNET2015.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Use the same sites as above</span>
<span class="va">calib_sites</span> <span class="op">&lt;-</span> <span class="va">fluxnet_sites</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span>
<span class="va">calib_sites</span> <span class="op">&lt;-</span> <span class="va">fluxnet_sites</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">%in%</span> <span class="va">calib_sites</span><span class="op">)</span>

<span class="co"># settings for data preparation</span>
<span class="va">settings_ingestr_fluxnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dir_hh <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/HH/"</span>,
  getswc <span class="op">=</span> <span class="cn">FALSE</span>,
  filter_ntdt <span class="op">=</span> <span class="cn">TRUE</span>,
  threshold_GPP <span class="op">=</span> <span class="fl">0.8</span>,
  remove_neg <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="co"># . format fluxnet GPP data ----</span>

<span class="va">p_model_fluxnet_calval</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span>
      <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
        siteinfo <span class="op">=</span> <span class="va">calib_sites</span>,
        source    <span class="op">=</span> <span class="st">"fluxnet"</span>,
        getvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gpp <span class="op">=</span> <span class="st">"GPP_NT_VUT_REF"</span>,
                       gpp_unc <span class="op">=</span> <span class="st">"GPP_NT_VUT_SE"</span><span class="op">)</span>,
        dir <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/DD/"</span>,
        settings <span class="op">=</span> <span class="va">settings_ingestr_fluxnet</span>,
        timescale <span class="op">=</span> <span class="st">"d"</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">p_model_fluxnet_calval</span>,
     file <span class="op">=</span> <span class="st">"~/trash/p_model_fluxnet_calval.rda"</span>,
     compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span>

<span class="co"># run the model for these parameters</span>
<span class="co"># optimized parameters from previous work (Stocker et al., 2020 GMD)</span>
<span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    kphio           <span class="op">=</span> <span class="fl">0.09423773</span>,
    soilm_par_a     <span class="op">=</span> <span class="fl">0.33349283</span>,
    soilm_par_b     <span class="op">=</span> <span class="fl">1.45602286</span>,
    tau_acclim_tempstress <span class="op">=</span> <span class="fl">10</span>,
    par_shape_tempstress  <span class="op">=</span> <span class="fl">0.0</span>
  <span class="op">)</span>

<span class="va">output_new</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span>
  <span class="va">p_model_fluxnet_drivers</span>,
  par <span class="op">=</span> <span class="va">params_modl</span>
  <span class="op">)</span>
<span class="co">#&gt; Warning: Error: Missing value in fapar for AR-Vir</span>

<span class="va">output_new</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">gpp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="prepare_forcing_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<!-- The `rsofun` package and framework includes two main models. The `pmodel` and `lm3-ppa` (which in part relies on pmodel compents). Here we give a short example on how to run the `pmodel` on the included demo datasets to familiarize yourself with both the data structure and the outputs. -->
<!-- ## Demo data -->
<!-- The package includes two demo datasets to run and validate pmodel output. These files can be directly loaded into your workspace by typing: -->
<!-- ```{r} -->
<!-- library(rsofun) -->
<!-- p_model_drivers -->
<!-- p_model_validation -->
<!-- ``` -->
<!-- These are real data from the French FR-Pue fluxnet site. We can use these data to run the model, together with observations of GPP we can also parameterize `pmodel` parameters. -->
<!-- ## Running the model -->
<!-- With all data prepared we can run the model using `runread_pmodel_f()`. This function takes the nested data structure and runs the model site by site, returning nested model output results matching the input drivers. -->
<!-- ```{r} -->
<!-- # optimized parameters from previous -->
<!-- # work -->
<!-- params_modl <- list( -->
<!--     kphio           = 0.09423773, -->
<!--     soilm_par_a     = 0.33349283, -->
<!--     soilm_par_b     = 1.45602286, -->
<!--     tau_acclim_tempstress = 10, -->
<!--     par_shape_tempstress  = 0.0 -->
<!--   ) -->
<!-- # run the model for these parameters -->
<!-- output <- rsofun::runread_pmodel_f( -->
<!--   p_model_drivers, -->
<!--   par = params_modl -->
<!--   ) -->
<!-- ``` -->
<!-- ### plotting output -->
<!-- We can now visualize both the model output and the measured values together. -->
<!-- ```{r} -->
<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- library(ggplot2) -->
<!-- # we only have one site so we'll unnest -->
<!-- # the main model output -->
<!-- model_data <- output %>% -->
<!--   filter(sitename == "FR-Pue") %>% -->
<!--   tidyr::unnest(data) -->
<!-- validation_data <- p_model_validation %>% -->
<!--   tidyr::unnest(data) -->
<!-- ggplot() + -->
<!--     geom_line( -->
<!--     data = model_data, -->
<!--     aes( -->
<!--       date, -->
<!--       gpp -->
<!--     ), -->
<!--     colour = "red" -->
<!--   ) + -->
<!--   geom_line( -->
<!--     data = validation_data, -->
<!--     aes( -->
<!--       date, -->
<!--       gpp -->
<!--     ) -->
<!--   ) + -->
<!--   labs( -->
<!--     x = "Date", -->
<!--     y = "GPP" -->
<!--   ) -->
<!-- ``` -->
<!-- ## Calibrating model parameters -->
<!-- To optimize new parameters based upon driver data and a validation dataset we must first specify an optimization strategy and settings, as well as parameter ranges. -->
<!-- ```{r} -->
<!--   settings <- list( -->
<!--     method              = "bayesiantools", -->
<!--     targetvars          = c("gpp"), -->
<!--     timescale           = list(targets_obs = "y"), -->
<!--     sitenames           = "FR-Pue", -->
<!--     metric              = cost_rmse_kphio, -->
<!--     dir_results         = "./", -->
<!--     name                = "ORG", -->
<!--     control = list( -->
<!--       sampler = "DEzs", -->
<!--       settings = list( -->
<!--         burnin = 1000, -->
<!--         iterations = 5000 -->
<!--       ) -->
<!--     ), -->
<!--     par = list( -->
<!--       kphio = list(lower=0.04, upper=0.1, init = 0.05), -->
<!--       a = list(lower=0, upper=5, init = 3.5), -->
<!--       b = list(lower=1, upper=5, init=3.5), -->
<!--       tau = list(lower=0, upper=15, init=1), -->
<!--       shape = list(lower=0, upper=0.1, init=0) -->
<!--       ) -->
<!--   ) -->
<!-- ``` -->
<!-- By default `rsofun` supports both optimization using the `GenSA` and `BayesianTools` packages. The above statement provides settings for a `BayesianTools` approach using the DEza sampler. For this example the burnin and iterations are kept artificially low. In a real scenario you will have to increase these values orders of magnitude. Keep in mind that optimization routines rely on a cost function, which, depending on its structure influences parameter selection. A limited set of cost functions is provided all starting with `cost_*` but the model structure is transparent and custom cost functions can be easily written. -->
<!-- In addition starting values and ranges are provided for the free parameters in the model. Free parameters include, kphio, a, b, tau and shape. Be mindful that with newer version of rsofun additional parameters might be introduced, so re-check vignettes and model descriptions when updating existing code. -->
<!-- With all settings defined the optimization function `calib_sofun()` can be called with driver data and observations specified. -->
<!-- ```{r eval = FALSE} -->
<!-- # calibrate the model and -->
<!-- # optimize free parameters -->
<!-- pars <- calib_sofun( -->
<!--     df_drivers = p_model_drivers,   -->
<!--     ddf_obs = p_model_validation, -->
<!--     settings = settings -->
<!--   ) -->
<!-- ``` -->
<!-- When successful the optimized parameters can be used to run subsequent modelling efforts, in this case slightly improving the model fit over a more global parameter set. -->
<!-- ```{r} -->
<!-- # reformatting the parameter list -->
<!-- params_modl <- list( -->
<!--     kphio           = pars$par[1], -->
<!--     soilm_par_a     = pars$par[2], -->
<!--     soilm_par_b     = pars$par[3], -->
<!--     tau_acclim_tempstress = pars$par[4], -->
<!--     par_shape_tempstress  = pars$par[5] -->
<!--   ) -->
<!-- # run the model for these parameters -->
<!-- output_new <- rsofun::runread_pmodel_f( -->
<!--   p_model_drivers, -->
<!--   par = params_modl -->
<!--   ) -->
<!-- # we only have one site so we'll unnest -->
<!-- # the main model output -->
<!-- model_data_new <- output_new %>% -->
<!--   filter(sitename == "FR-Pue") %>% -->
<!--   tidyr::unnest(data) -->
<!--   ggplot() + -->
<!--     geom_line( -->
<!--     data = model_data, -->
<!--     aes( -->
<!--       date, -->
<!--       gpp -->
<!--     ), -->
<!--     colour = "blue", -->
<!--     alpha = 0.3 -->
<!--   ) + -->
<!--   geom_line( -->
<!--     data = validation_data, -->
<!--     aes( -->
<!--       date, -->
<!--       gpp -->
<!--     ) -->
<!--   ) + -->
<!--     geom_line( -->
<!--     data = model_data_new, -->
<!--     aes( -->
<!--       date, -->
<!--       gpp -->
<!--     ), -->
<!--     colour = "red" -->
<!--   ) + -->
<!--   labs( -->
<!--     x = "Date", -->
<!--     y = "GPP" -->
<!--   ) -->
<!-- ``` -->
<!-- For details on the optimization settings we refer to the manuals of [GenSA](https://cran.r-project.org/web/packages/GenSA/index.html) and [BayesianTools](https://github.com/florianhartig/BayesianTools). -->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Stocker Benjamin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
