---
title: "Example for using rsofun"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
library(rsofun)
library(dplyr)
library(readr)
```

## Example using rsofun for P-model simulations

The following describes the use of `rsofun` for an ensemble of site-scale P-model simulations, including steps for model calibration and evaluation (benchmarking). `rsofun` is designed in a modular and hierarchical fashion. This enables multiple setups within the same modelling framework. The P-model implementation in `rsofun` is described in Stocker et al. (2020) **Geosci. Mod. Dev.**. 

In the P-model setup, the model requires time series of daily meteorological data as input and is calibrated against observational GPP data. This example describes simulations at a subset of FLUXNET 2015 Tier 1 sites, using GPP based on the night-time flux partitioning method as calibration target and benchmark (no worries, an out-of-sample calibration/evaluation function is available, too). 

### Site selection and meta data

We manually define a subset of sites that are part of the FLUXNET 2015 Tier 1 set of sites:
```{r}
mysites <- c("BE-Vie", "DE-Tha", "DK-Sor", "FI-Hyy", "IT-Col", "NL-Loo", "US-MMS", "US-WCr", "US-UMB", "US-Syv", "DE-Hai")
```

A small number of meta data variables have to be specified for each site specifically to define the simulation years. This information is also used for input, calibration, and evaluation data ingestion. Required meta information is specified for each site (in rows) and a number of variables:

- `lat` for latitude (decimal degrees)
- `lon` for longitude (decimal degrees) - this is only used for data ingestion but not for the P-model simulation with `rsofun`.
- `elv` for elevation (m a.s.l.)
- `year_start` and `year_end` specifying years covered by the simulation
- `whc` for the soil water holding capacity
- `koeppen_code` to group sites for evaluation by Koeppen-Geiger climate zones.

This information is provided in file `siteinfo_fluxnet2015.csv`. This file is created as described in (and using code from) [metainfo_fluxnet2015](https://github.com/stineb/metainfo_fluxnet2015). 
```{r}
siteinfo <- readr::read_csv("~/rsofun/siteinfo_fluxnet2015.csv") %>%
  filter(sitename %in% mysites) %>%
  mutate(date_start = lubridate::ymd(paste0(year_start, "-01-01"))) %>%
  mutate(date_end = lubridate::ymd(paste0(year_end, "-12-31")))
```

### Simulation settings

<!-- Create a site meta info table that contains all the site-specific information that is used to force site-simulations (e.g. starting year, number of simulations years, elevation, etc.). For FLUXNET2015 data, required meta info is provided by the `rsofun` package (data frame `rsofun::metainfo_Tier1_sites_kgclimate_fluxnet2015`). -->
<!-- ```{r} -->
<!-- path_siteinfo <- "~/siteinfo_example_fortran.csv" -->
<!-- siteinfo <- rsofun::metainfo_Tier1_sites_kgclimate_fluxnet2015 %>%  -->
<!--   dplyr::filter(sitename %in% mysites) %>% -->
<!--   write_csv(path = path_siteinfo) -->
<!-- ``` -->

Specify additional simulation parameters that are identical for all site-scale simulations.
```{r}
params_siml <- list(
  spinup             = TRUE,
  spinupyears        = 10,
  recycle            = 1,
  soilmstress        = FALSE,
  tempstress         = FALSE,
  calc_aet_fapar_vpd = FALSE,
  in_ppfd            = TRUE,
  in_netrad          = FALSE,
  outdt              = 1,
  ltre               = FALSE,
  ltne               = FALSE,
  ltrd               = FALSE,
  ltnd               = FALSE,
  lgr3               = TRUE,
  lgn3               = FALSE,
  lgr4               = FALSE
	)
```

Run `prepare_setup_sofun()` to define the simulation settings that contain all the information specified by the two steps above (meta info, and simulation parameters), global simulation parameters are wrapped inside an additional column `params_siml`, added to the site meta info dataframe.
```{r}
settings_sims <- prepare_setup_sofun(siteinfo = siteinfo, params_siml = params_siml)
```

### Define model parameters

First, let's do it by hand (calibration of parameters is shown later).
```{r}
params_modl <- list(
	kphio           = 0.05,
	soilm_par_a     = 1.0,
	soilm_par_b     = 0.0,
	vpdstress_par_a = 0.2,
	vpdstress_par_b = 0.2,
	vpdstress_par_m = 5
	)
```

### Define soil parameters

For now, this is implemented as an illustration. Should be made site-specific. Values entered here take no effect.
```{r}
df_soiltexture <- bind_rows(
  top    = tibble(layer = "top",    fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1),
  bottom = tibble(layer = "bottom", fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1)
)
```

### Get input

Input data, used as model forcing, is collected using the [ingestr](https://stineb.github.io/ingestr/) package. A brief description for how to use it for our present application is provided here. Data is collected by data source. 

#### Meteo data

The following ingests meteorological data from the FLUXNET 2015 files for variables temperature, precipitation, VPD, shortwave incoming radiation, net radiation, and atmospheric pressure. Arguments that are specific for this data source are provided in the `settings` list. The data object `ddf_fluxnet` is organised as a nested table with rows for sites and time series nested inside the column `data`. See [here](https://tidyr.tidyverse.org/reference/nest.html) for how to handle nested dataframes. 
```{r message=FALSE, warning=FALSE}
library(ingestr)
ddf_fluxnet <- ingest(
  siteinfo = siteinfo,
  source    = "fluxnet2015",
  getvars   = list(temp = "TA_F_DAY", prec = "P_F", vpd  = "VPD_F_DAY", swin =  "SW_IN_F", patm = "PA_F"),
  dir       = "~/data/FLUXNET-2015_Tier1/20191024/DD/",
  settings  = list(dir_hh = "~/data/FLUXNET-2015_Tier1/20191024/HH/", getswc = FALSE),
  timescale = "d"
  )
```

Some meteo data is not available from FLUXNET. Extract it from CRU global climate files instead.
```{r}
ddf_cru <- ingest(
  siteinfo = siteinfo,
  source    = "cru",
  getvars   = list(ccov = "cld"),
  dir       = "~/data/cru/ts_4.01/"
  )
```

Combine the two meteo data frames into one, containing `ccov` (cloud cover) from CRU and all other variables from FLUXNET.
```{r}
ddf_meteo <- ddf_fluxnet %>% 
  tidyr::unnest(data) %>% 
  left_join(
    ddf_cru %>% 
      tidyr::unnest(data),
    by = c("sitename", "date")
  ) %>% 
  group_by(sitename) %>% 
  tidyr::nest()
```

#### fAPAR data

fAPAR data is prescribed in the P-model setup. The following extracts data MODIS FPAR data from Google Earth Engine (see a complete description for how to set up the GEE API and download library [here](https://stineb.github.io/ingestr/articles/example.html#google-earth-engine)). 

The following example is for downloading MODIS FPAR data (MODIS/006/MCD15A3H, band Fpar). 
```{r}
settings_gee <- get_settings_gee( 
  bundle = "modis_fpar", 
  python_path = system("which python", intern = TRUE),
  gee_path = "~/google_earth_engine_subsets/gee_subset/",
  data_path = "~/data/gee_subsets/",
  splined = TRUE,
  do_plot_interpolated = FALSE,
  overwrite_raw = FALSE,
  overwrite_interpol = FALSE
  )
```

This can now be used to download the data to the directory specified by argument `data_path` of function `get_settings_gee()` and to read data into R.
```{r}
ddf_fapar <- ingest(
  siteinfo = siteinfo,
  source = "gee",
  settings = settings_gee,
  verbose = FALSE
  )
```

#### Collect all drivers

Finally, we can collect forcing data, simulation parameters, and site meta info into a single object that will be used to drive rsofun.
```{r}
df_drivers <- collect_drivers_sofun( 
  settings       = settings_sims, 
  meteo          = ddf_meteo, 
  fapar          = ddf_fapar,
  df_soiltexture = df_soiltexture
  )
```






First, define input settings.
```{r}
settings_input <-  list(
    data                     = NA,
    temperature              = "fluxnet2015",
    precipitation            = "fluxnet2015",
    vpd                      = "fluxnet2015",
    ppfd                     = "fluxnet2015",
    netrad                   = "fluxnet2015",  #  c("fluxnet2015", "watch_wfdei"),
    patm                     = "fluxnet2015",
    netrad                   = NA,
    cloudcover               = "cru",
    path_input               = "~/sofun_inputs/example/",
    path_watch_wfdei         = "~/data/watch_wfdei/",
    path_cru                 = "~/data/cru/ts_4.01/",
    path_MODIS_FPAR_MCD15A3H = "~/data/fluxnet_subsets/fapar_MODIS_FPAR_MCD15A3H_gee_MCD15A3H_fluxnet2015_gee_subset/",
    path_MODIS_EVI_MOD13Q1   = "~/data/fluxnet_subsets/fapar_MODIS_EVI_MOD13Q1_gee_MOD13Q1_fluxnet2015_gee_subset/",
    path_co2                 = "~/data/co2/cCO2_rcp85_const850-1765.csv",
    path_fluxnet2015         = "~/data/FLUXNET-2015_Tier1/20191024/DD/",
    path_fluxnet2015_hh      = "~/data/FLUXNET-2015_Tier1/20191024/HH/",
    get_from_remote          = FALSE,
    settings_gee             = get_settings_gee( 
      bundle      = "fpar", 
      python_path = "/Users/benjaminstocker/Library/Enthought/Canopy_64bit/User/bin/python",
      gee_path    = "~/gee_subset/gee_subset/"
      ),
  fapar = "MODIS_FPAR_MCD15A3H",
  splined_fapar = TRUE
  )
```

Then, get the input data.
```{r message=FALSE, warning=FALSE, echo=FALSE}
ddf_input <- prepare_input_sofun(
  settings_input             = settings_input,
  settings_sims              = settings_sims,
  overwrite_csv_climate_lev1 = FALSE,
  overwrite_csv_climate_lev2 = TRUE,
  overwrite_csv_climate_lev3 = TRUE,
  overwrite_rdata_climate    = TRUE,
  overwrite_csv_fapar        = FALSE,
  verbose                    = FALSE
  )
```

### Run the model

Run the model for all the sites specified in the first step.
```{r}
df_drivers <- collect_drivers_sofun( 
  settings       = settings_sims, 
  forcing        = ddf_input, 
  df_soiltexture = df_soiltexture
  )

## run for a single site
mod <- run_sofun_f_bysite( 
  df_drivers$sitename[1], 
  df_drivers$params_siml[[1]], 
  df_drivers$siteinfo[[1]], 
  df_drivers$forcing[[1]], 
  df_drivers$df_soiltexture[[1]], 
  params_modl = params_modl, 
  makecheck = TRUE 
  )

## Run for the full set of sites
ptm <- proc.time()
df_output <- runread_sofun_f(
     df_drivers, 
     params_modl = params_modl, 
     makecheck = TRUE,
     parallel = FALSE
     )
print(ptm)

# microbenchmark::microbenchmark(
#   runread_sofun_f(
#     df_drivers, 
#     params_modl = params_modl, 
#     makecheck = TRUE,
#     parallel = TRUE,
#     ncores = 4
#     ),
#   runread_sofun_f(
#     df_drivers, 
#     params_modl = params_modl, 
#     makecheck = TRUE,
#     parallel = FALSE
#     ),
#   times = 5,
#   units = 's'
# )

df_output$out_sofun[[1]] %>% 
  ggplot(aes(x=date, y=gpp)) +
  geom_line() + 
  labs(title = df_output$sitename[[1]], subtitle = "SOFUN output")
```

### Calibrate

Define calibration settings.
```{r}
## Define calibration settings common for all setups
settings_calib <- list(
  method              = "gensa",
  targetvars          = c("gpp"),
  timescale           = list( gpp = "d" ),
  path_fluxnet2015    = "~/data/FLUXNET-2015_Tier1/20191024/DD/",
  path_fluxnet2015_hh = "~/data/FLUXNET-2015_Tier1/20191024/HH/",
  threshold_GPP       = 0.5,
  path_gepisat        = "~/data/gepisat/v3_fluxnet2015/daily_gpp/",
  maxit               = 5, # (5 for gensa) (30 for optimr)    #
  sitenames           = mysites,
  filter_temp_max     = 35.0,
  filter_drought      = FALSE,
  metric              = "rmse",
  dir_results         = "./",
  name                = "ORG",
  par                 = list( kphio = list( lower=0.03, upper=0.07, init=0.0496 ) ),
  datasource          = list( gpp = "fluxnet2015_NT" ),
  filter_temp_min     = NA,
  filter_soilm_min    = NA
 )
```

Get calibration target data.
```{r warning=FALSE, message=FALSE}
ddf_obs_calib <- get_obs_calib(
  settings_calib = settings_calib,
  dplyr::select(df_drivers, sitename, siteinfo) %>% tidyr::unnest(siteinfo),
  settings_input
  )
```

Calibrate the model.

```{r warning=FALSE, message=FALSE}
set.seed(1982)
settings_calib <- calib_sofun(
  settings_calib,
  df_drivers,
  ddf_obs = ddf_obs_calib
  )
```

The calibrated parameters are returned by `calib_sofun()` as part of the list:
```{r}
print(settings_calib$par_opt)
```


### Evaluate

Run the model once again with these parameters and evaluate results.
```{r warning=FALSE, message=FALSE}
mylist <- readr::read_csv("~/eval_pmodel/myselect_fluxnet2015.csv") %>% 
  dplyr::filter( use==1 ) %>% 
  dplyr::pull( Site )

settings_eval <- list(
  sitenames           = settings_sims$sitename,
  sitenames_siteplots = mylist,
  agg                 = 8,
  path_fluxnet2015_d  = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1d/original/unpacked/",
  path_fluxnet2015_w  = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_7d/original/unpacked/",
  path_fluxnet2015_m  = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1m/original/unpacked/",
  path_fluxnet2015_y  = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1y/original/unpacked/",
  path_gepisat_d      = "~/data/gepisat/v3_fluxnet2015/daily_gpp/",
  benchmark           = list( gpp = c("fluxnet2015_NT") ),
  remove_premodis     = TRUE
  )
```

Get evaluation data (benchmarking data).
```{r warning=FALSE, message=FALSE}
filn <- "./obs_eval.Rdata"
if (file.exists(filn)){
  load(filn)
} else {
  obs_eval  <- get_obs_eval( 
    settings_eval = settings_eval, 
    settings_sims = settings_sims, 
    overwrite     = TRUE, 
    light         = TRUE,
    add_forcing   = FALSE
  )
  save(obs_eval, file = filn)
} 
```

Now run the model with calibrated parameters.
```{r}
params_modl <- list(
  kphio           = settings_calib$par_opt[["kphio"]],
  soilm_par_a     = 1.0,
  soilm_par_b     = 0.0,
  vpdstress_par_a = 0.2,
  vpdstress_par_b = 0.2,
  vpdstress_par_m = 5
  )

mod <- runread_sofun_f(
  df_drivers, 
  params_modl = params_modl, 
  makecheck = TRUE
  ) %>% 
  rename(id = sitename) %>% 
  unnest(out_sofun)
```

And finally do the evaluation.
```{r warning=FALSE, message=FALSE}
out_eval <- eval_sofun( 
  mod, 
  settings_eval, 
  settings_sims, 
  obs_eval = obs_eval, 
  overwrite = TRUE, 
  light = FALSE 
  )
```

Print some results.
```{r}
out_eval$gpp$fluxnet2015$metrics$xdaily_pooled
```

```{r}
out_eval$gpp$fluxnet2015$data$xdf %>% rbeni::analyse_modobs2("mod", "obs", type = "heat")
```

```{r}
out_eval$gpp$fluxnet2015$data$ddf %>% 
  dplyr::filter(sitename=="BE-Vie" & year(date) < 2005) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = obs), col="black") +
  geom_line(aes(y = mod), col="red") + 
  labs(title = "BE-Vie")

out_eval$gpp$fluxnet2015$data$ddf %>% 
  dplyr::filter(sitename=="AU-Dry" & year(date) > 2010) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = obs), col="black") +
  geom_line(aes(y = mod), col="red") + 
  labs(title = "AU-Dry")
```
