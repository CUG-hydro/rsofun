---
title: "Consistency check 1: BiomeE-Allocation vs. SOFUN"
output: html_document
---

Compare output files written by original BiomeE-Allocation (Enshneg Weng) with SOFUN in branch lm3ppa_BiomeE_test_rsofun. 

```{r setup, include=T}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(rbeni)
library(rlang)
```

Set local path of original BiomeE-Allocation repo and SOFUN.
```{r}
path_orig  <- "/Users/benjaminstocker/cagibi/BiomeE-Allocation/model"
path_sofun <- "/Users/benjaminstocker/sofun"
```

Define plotting functions by variable.
```{r}
plot_tseries_byvar <- function(var, df_biomeE, df_sofun){
  
  var_biomeE <- paste0(var, "_biomeE")
  var_sofun  <- paste0(var, "_sofun")
  
  df <- df_biomeE %>% 
    dplyr::select(year, {{var}}) %>% 
    dplyr::rename(biomeE = {{var}}) %>% 
    left_join(
      df_sofun %>% 
        dplyr::select(year,{{var}}) %>% 
        dplyr::rename(sofun = {{var}}),
      by = "year"
    ) %>% 
    pivot_longer(cols = c(biomeE, sofun), names_to = "source", values_to = "var")
  
  gg <- df %>% 
    ggplot(aes(x = year, y = var, color = source)) +
    geom_line() +
    labs(x = "Year", y = var)
  
  return(gg)
}

plot_modobs_byvar <- function(var, df_biomeE, df_sofun){
  
  var_biomeE <- paste0(var, "_biomeE")
  var_sofun  <- paste0(var, "_sofun")
  
  df <- df_biomeE %>% 
    dplyr::select(year, {{var}}) %>% 
    dplyr::rename(var_biomeE = {{var}}) %>% 
    left_join(
      df_sofun %>% 
        dplyr::select(year,{{var}}) %>% 
        dplyr::rename(var_sofun = {{var}}),
      by = "year"
    )
  modobs <- df %>% 
    analyse_modobs2("var_biomeE", "var_sofun", relative = TRUE)
  gg <- modobs$gg +
    labs(x = var_biomeE, y = var_sofun)
  
  return(gg)
}
```

Forcing data: ORNL (11 years)

## Running BiomeE-Allocation in terminal and getting outputs as csv files

```{r eval=FALSE}
here <- getwd()
setwd(path_orig)
system("gfortran src/main.f90 src/datatypes.f90 src/soil.f90 src/vegetation.f90 -o ess")
system("./ess")
setwd(here)
```

#### Getting BiomeE outputs

```{r, message=FALSE, include=T, eval=TRUE}
#biomeE_out_hourly_tile <- read_csv("Hourly_tile_test.csv")
biomeE_out_daily_tile     <- read_csv(paste0(path_orig, "/output/daily_tile_test.csv"))
biomeE_out_daily_cohorts  <- read_csv(paste0(path_orig, "/output/daily_cohorts_test.csv"))
biomeE_out_annual_tile    <- read_csv(paste0(path_orig, "/output/annual_tile_test.csv"))
biomeE_out_annual_cohorts <- read_csv(paste0(path_orig, "/output/annual_cohorts_test.csv"))
```

## Running SOFUN in terminal and getting outputs as csv files

```{r, include=F, eval=FALSE}
here <- getwd()
setwd(path_sofun)
system("make clean")
system("make lm3ppa")
system("./runlm3ppa")
setwd(here)
```

#### Getting SOFUN outputs

```{r, include=T, eval=T}
#sofun_out_hourly_tile <- read_csv("Hourly_tile_test.csv")
sofun_out_daily_tile     <- read_csv(paste0(path_sofun, "/output/Daily_tile_test.csv"))
sofun_out_daily_cohorts  <- read_csv(paste0(path_sofun, "/output/Daily_cohorts_test.csv"))
sofun_out_annual_tile    <- read_csv(paste0(path_sofun, "/output/Annual_tile_test.csv"))
sofun_out_annual_cohorts <- read_csv(paste0(path_sofun, "/output/Annual_cohorts_test.csv"))
```

### Plots of annual tile outputs

```{r, include=T, eval=T}
varnams_annual_biomeE <- names(biomeE_out_annual_tile)[c(-1, -length(names(biomeE_out_annual_tile)))]
varnams_annual_sofun <- names(sofun_out_annual_tile)[c(-1, -length(names(sofun_out_annual_tile)))]
all.equal(varnams_annual_biomeE, varnams_annual_sofun)

## in sofun but not in biomee:
varnams_annual_sofun[which(!(varnams_annual_sofun %in% varnams_annual_biomeE))]

out_modobs <- purrr::map(as.list(varnams_annual_biomeE),
                         ~plot_modobs_byvar(., biomeE_out_annual_tile, sofun_out_annual_tile))
out_tseries <- purrr::map(as.list(varnams_annual_biomeE),
                         ~plot_tseries_byvar(., biomeE_out_annual_tile, sofun_out_annual_tile))
purrr::map(out_tseries, ~print(.))
```

See that N_fxd and N_loss plots are empty because these variables are equal to 0.

### Plots of annual cohorts outputs

```{r, include=T, eval=F}
dim(biomeE_out_annual_cohorts)
dim(sofun_out_annual_cohorts)
sofun_out_annual_cohorts <- sofun_out_annual_cohorts[1:34142,][,-24]
biomeE_out_annual_cohorts <- biomeE_out_annual_cohorts[,-24]

plot_dfs <- lapply(names(biomeE_out_annual_cohorts),function(nm)data.frame(col1 = biomeE_out_annual_cohorts[,1],col2 = biomeE_out_annual_cohorts[,nm], col3 = sofun_out_annual_cohorts[,nm]))

for (idx in seq_along(plot_dfs))
  print(ggplot()+geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col2),color="blue") +
      geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col3),color="red")+
      ggtitle(names(biomeE_out_annual_cohorts)[idx]))

```


### Plots of hourly tile outputs

```{r, include=T, eval=F}
dim(biomeE_out_hourly_tile)
dim(sofun_out_hourly_tile)
biomeE_out_hourly_tile <- subset(biomeE_out_hourly_tile, year <= 1800)

plot_dfs <- lapply(names(biomeE_out_hourly_tile), function(nm) data.frame(col1 = biomeE_out_hourly_tile[,1], col2 = biomeE_out_hourly_tile[,nm], col3 = sofun_out_hourly_tile[,nm]))

for (idx in seq_along(plot_dfs))
  print(ggplot()+geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col2),color="blue") +
      geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col3),color="red")+
      ggtitle(names(biomeE_out_hourly_tile)[idx]))
```

### Plots of daily tile outputs

```{r, include=T, eval=T}
dim(biomeE_out_daily_tile)
dim(sofun_out_daily_tile)
biomeE_out_daily_tile <- subset(biomeE_out_daily_tile, year <= 1800)[,-36]
sofun_out_daily_tile <- sofun_out_daily_tile[,-36]

plot_dfs <- lapply(names(biomeE_out_daily_tile),function(nm)data.frame(col1 = biomeE_out_daily_tile[,1],col2 = biomeE_out_daily_tile[,nm], col3 = sofun_out_daily_tile[,nm]))

for (idx in seq_along(plot_dfs))
  print(ggplot()+geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col2),color="blue") +
      geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col3),color="red")+
      ggtitle(names(biomeE_out_daily_tile)[idx]))
```

### Plots of daily cohorts outputs

```{r, include=T, eval=T}
dim(biomeE_out_daily_cohorts)
dim(sofun_out_daily_cohorts)
sofun_out_daily_cohorts <- sofun_out_daily_cohorts[1:12461830,][,-28]
biomeE_out_daily_cohorts <- biomeE_out_daily_cohorts[,-28]

plot_dfs <- lapply(names(biomeE_out_daily_cohorts),function(nm)data.frame(col1 = biomeE_out_daily_cohorts[,1],col2 = biomeE_out_daily_cohorts[,nm], col3 = sofun_out_daily_cohorts[,nm]))

for (idx in seq_along(plot_dfs))
  print(ggplot()+geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col2),color="blue") +
      geom_smooth(data = plot_dfs[[idx]], aes(x=col1, y=col3),color="red")+
      ggtitle(names(biomeE_out_daily_cohorts)[idx]))
```


Compared to BiomeE model outputs and found differences that are due to plant-soil feedbacks, i.e., when holding mineralN constant, the outputs are exactly identical. Slightly different dynamics are caused by mineralN. See file vegetation.mod.f90 in sofun and BiomE-Allocation (vegn%mineralN = 0.00025).





