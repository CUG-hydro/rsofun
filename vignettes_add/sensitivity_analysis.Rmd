---
title: "sensitivity_analysis"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(dplyr)
library(tibble)
library(rsofun)
library(ggplot2)
library(ggpubr)
```

# DBH function

### Understory 

#### Weng et al 2015

```{r,echo=FALSE,eval=TRUE}
ggplot(data.frame(x = c(0, 1.5)), aes(x)) + stat_function(fun = ~ 0.075*(1+9*exp(-60*.x))/(1+exp(-60*.x)))+
  labs(x='DBH (m)', y='Deathrate')
```

#### Modified in LM3-PPA
```{r,echo=FALSE,eval=TRUE}
ggplot(data.frame(x = c(0, 1.5)), aes(x)) + stat_function(fun = ~ 2.25*exp(-40*.x)/(1+exp(-40*.x)))+
  labs(x='DBH (m)', y='Deathrate') + theme_bw()
```

### Canopy

#### Weng et al 2015

```{r,echo=FALSE,eval=TRUE}
ggplot(data.frame(x = c(0, 1.5)), aes(x)) + stat_function(fun = ~ 0.01*(1+5*exp(4*(.x-2)))/(1+exp(4*(.x-2)))) +
  labs(x='DBH (m)', y='Deathrate')
```

#### Modified in LM3-PPA
```{r,echo=FALSE,eval=TRUE}

ggplot(data.frame(x = c(0, 1.5)), aes(x)) + stat_function(fun = ~ 0.05*exp(1*.x),col="blue") + stat_function(fun = ~ 0.05*exp(3*.x),col="red") + annotate("text", x = 0.3, y = 1, label = "0.05*exp(1*dbh)",col="blue") + annotate("text", x = 0.3, y = 0.9, label = "0.05*exp(3*dbh)", col="red") +
  labs(x='DBH (m)', y='Deathrate') + theme_bw() + scale_y_continuous(limits = c(0,1))

ggplot(data.frame(x = c(0, 1.5)), aes(x)) + stat_function(fun = ~ 10*(exp(3*(.x-2)))/(1+exp(3*(.x-2))),col="blue") + stat_function(fun = ~ 10*(exp(5*(.x-2)))/(1+exp(5*(.x-2))),col="red") + annotate("text", x = 0.3, y = 1, label = "10*exp(3*(dbh-2))/(1+exp(3*(dbh-2))",col="blue") + annotate("text", x = 0.3, y = 0.9, label = "10*exp(5*(dbh-2))/(1+exp(5*(dbh-2))", col="red") +
  labs(x='DBH (m)', y='Deathrate')+ scale_y_continuous(limits = c(0,1))

ggplot(data.frame(x = c(0, 1.5)), aes(x)) + stat_function(fun = ~ exp(0.2*.x)-1,col="blue") + stat_function(fun = ~ exp(0.5*.x)-1,col="red") + annotate("text", x = 0.3, y = 1, label = "exp(0.2*dbh)-1",col="blue") + annotate("text", x = 0.3, y = 0.9, label = "exp(0.5*dbh)-1", col="red") +
  labs(x='DBH (m)', y='Deathrate') + theme_bw() + scale_y_continuous(limits = c(0,1))

```

## Sensitivity analysis for calibratable parameters

### kphio interval

```{r, include=FALSE, eval=FALSE}
load("~/data/rsofun/df_drivers_pmodel_dbh.RData")

kphio_values <- seq(0.04, 0.09, 0.001)

kphio_eval_interval <- data.frame()

for(i in kphio_values){
  
  df_drivers$params_species[[1]]$kphio  <- i
  
  df_calib_DBH <- runread_lm3ppa_f(
    df_drivers,
    makecheck = TRUE,
    parallel = FALSE
  )
  
  kphio_eval_rows <-  df_calib_DBH$data[[1]]$output_annual_tile  %>% tail(500) %>%
    summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Density=mean(Density12), Biomass=mean(plantC)) %>%
    mutate(Param_val = i)
  
  kphio_eval_interval <- rbind(kphio_eval_interval,kphio_eval_rows)

}

save(kphio_eval_interval, file = "~/data/rsofun/kphio_eval_interval_pmodel_dbh.RData")

```

```{r,echo=FALSE,eval=TRUE}

load("~/data/rsofun/kphio_eval_interval_pmodel_dbh.RData")

GPP_plot <- kphio_eval_interval %>% 
  ggplot(aes(x = Param_val, y = GPP)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "kphio", y = "GPP") + 
  ggtitle("Target variable: GPP")
  
LAI_plot <- kphio_eval_interval %>% 
  ggplot(aes(x = Param_val, y = LAI)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "kphio", y = "LAI") + 
  ggtitle("Target variable: LAI")  
  
Density_plot <- kphio_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Density)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "kphio", y = "Density") + 
  ggtitle("Target variable: Density")  

Biomass_plot <- kphio_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Biomass)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "kphio", y = "Biomass") + 
  ggtitle("Target variable: Biomass")

ggarrange(GPP_plot,LAI_plot,Density_plot,Biomass_plot, ncol = 2, nrow = 2)

```

### phiRL interval

```{r, include=FALSE, eval=FALSE}
load("~/data/rsofun/df_drivers_pmodel_dbh.RData")

phiRL_values <- seq(1, 6, 0.1)

phiRL_eval_interval <- data.frame()

for(i in phiRL_values){
  
  df_drivers$params_species[[1]]$phiRL  <- i
  
  df_calib_DBH <- runread_lm3ppa_f(
    df_drivers,
    makecheck = TRUE,
    parallel = FALSE
  )
  
  phiRL_eval_rows <-  df_calib_DBH$data[[1]]$output_annual_tile  %>% tail(500) %>%
    summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Density=mean(Density12), Biomass=mean(plantC)) %>%
    mutate(Param_val = i)
  
  phiRL_eval_interval <- rbind(phiRL_eval_interval,phiRL_eval_rows)

}

save(phiRL_eval_interval, file = "~/data/rsofun/phiRL_eval_interval_pmodel_dbh.RData")

```

```{r,echo=FALSE,eval=TRUE}

load("~/data/rsofun/phiRL_eval_interval_pmodel_dbh.RData")

GPP_plot <- phiRL_eval_interval %>% 
  ggplot(aes(x = Param_val, y = GPP)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "phiRL", y = "GPP") + 
  ggtitle("Target variable: GPP")
  
LAI_plot <- phiRL_eval_interval %>% 
  ggplot(aes(x = Param_val, y = LAI)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "phiRL", y = "LAI") + 
  ggtitle("Target variable: LAI")  
  
Density_plot <- phiRL_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Density)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "phiRL", y = "Density") + 
  ggtitle("Target variable: Density")  

Biomass_plot <- phiRL_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Biomass)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "phiRL", y = "Biomass") + 
  ggtitle("Target variable: Biomass")

ggarrange(GPP_plot,LAI_plot,Density_plot,Biomass_plot, ncol = 2, nrow = 2)

```

### LAI_light interval

```{r, include=FALSE, eval=FALSE}
load("~/data/rsofun/df_drivers_pmodel_dbh.RData")

LAI_light_values <- seq(1, 6, 0.1)

LAI_light_eval_interval <- data.frame()

for(i in LAI_light_values){
  
  df_drivers$params_species[[1]]$LAI_light  <- i
  
  df_calib_DBH <- runread_lm3ppa_f(
    df_drivers,
    makecheck = TRUE,
    parallel = FALSE
  )
  
  LAI_light_eval_rows <-  df_calib_DBH$data[[1]]$output_annual_tile  %>% tail(500) %>%
    summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Density=mean(Density12), Biomass=mean(plantC)) %>%
    mutate(Param_val = i)
  
  LAI_light_eval_interval <- rbind(LAI_light_eval_interval,LAI_light_eval_rows)

}

save(LAI_light_eval_interval, file = "~/data/rsofun/LAI_light_eval_interval_pmodel_dbh.RData")

```

```{r,echo=FALSE,eval=TRUE}

load("~/data/rsofun/LAI_light_eval_interval_pmodel_dbh.RData")

GPP_plot <- LAI_light_eval_interval %>% 
  ggplot(aes(x = Param_val, y = GPP)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "LAI_light", y = "GPP") + 
  ggtitle("Target variable: GPP")
  
LAI_plot <- LAI_light_eval_interval %>% 
  ggplot(aes(x = Param_val, y = LAI)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "LAI_light", y = "LAI") + 
  ggtitle("Target variable: LAI")  
  
Density_plot <- LAI_light_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Density)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "LAI_light", y = "Density") + 
  ggtitle("Target variable: Density")  

Biomass_plot <- LAI_light_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Biomass)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "LAI_light", y = "Biomass") + 
  ggtitle("Target variable: Biomass")

ggarrange(GPP_plot,LAI_plot,Density_plot,Biomass_plot, ncol = 2, nrow = 2)

```

### tf_base interval

```{r, include=FALSE, eval=FALSE}
load("~/data/rsofun/df_drivers_pmodel_dbh.RData")

tf_base_values <- seq(0.1, 3, 0.05)

tf_base_eval_interval <- data.frame()

for(i in tf_base_values){
  
  df_drivers$params_tile[[1]]$tf_base  <- i
  
  df_calib_DBH <- runread_lm3ppa_f(
    df_drivers,
    makecheck = TRUE,
    parallel = FALSE
  )
  
  tf_base_eval_rows <-  df_calib_DBH$data[[1]]$output_annual_tile  %>% tail(500) %>%
    summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Density=mean(Density12), Biomass=mean(plantC)) %>%
    mutate(Param_val = i)
  
  tf_base_eval_interval <- rbind(tf_base_eval_interval,tf_base_eval_rows)

}

save(tf_base_eval_interval, file = "~/data/rsofun/tf_base_eval_interval_pmodel_dbh.RData")

```

```{r,echo=FALSE,eval=TRUE}
load("~/data/rsofun/tf_base_eval_interval_pmodel_dbh.RData")

GPP_plot <- tf_base_eval_interval %>% 
  ggplot(aes(x = Param_val, y = GPP)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "tf_base", y = "GPP") + 
  ggtitle("Target variable: GPP")
  
LAI_plot <- tf_base_eval_interval %>% 
  ggplot(aes(x = Param_val, y = LAI)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "tf_base", y = "LAI") + 
  ggtitle("Target variable: LAI")  
  
Density_plot <- tf_base_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Density)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "tf_base", y = "Density") + 
  ggtitle("Target variable: Density")  

Biomass_plot <- tf_base_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Biomass)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "tf_base", y = "Biomass") + 
  ggtitle("Target variable: Biomass")

ggarrange(GPP_plot,LAI_plot,Density_plot,Biomass_plot, ncol = 2, nrow = 2)

```

### par_mort interval

```{r, include=FALSE, eval=FALSE}
load("~/data/rsofun/df_drivers_pmodel_dbh.RData")

par_mort_values <- seq(1, 4, 0.05)

par_mort_eval_interval <- data.frame()

for(i in par_mort_values){
  
  df_drivers$params_tile[[1]]$par_mort  <- i
  
  df_calib_DBH <- runread_lm3ppa_f(
    df_drivers,
    makecheck = TRUE,
    parallel = FALSE
  )
  
  par_mort_eval_rows <-  df_calib_DBH$data[[1]]$output_annual_tile  %>% tail(500) %>%
    summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Density=mean(Density12), Biomass=mean(plantC)) %>%
    mutate(Param_val = i)
  
  par_mort_eval_interval <- rbind(par_mort_eval_interval,par_mort_eval_rows)

}

save(par_mort_eval_interval, file = "~/data/rsofun/par_mort_eval_interval_pmodel_dbh.RData")

```

```{r,echo=FALSE,eval=TRUE}
load("~/data/rsofun/par_mort_eval_interval_pmodel_dbh.RData")

GPP_plot <- par_mort_eval_interval %>% 
  ggplot(aes(x = Param_val, y = GPP)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "par_mort", y = "GPP") + 
  ggtitle("Target variable: GPP")
  
LAI_plot <- par_mort_eval_interval %>% 
  ggplot(aes(x = Param_val, y = LAI)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "par_mort", y = "LAI") + 
  ggtitle("Target variable: LAI")  
  
Density_plot <- par_mort_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Density)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "par_mort", y = "Density") + 
  ggtitle("Target variable: Density")  

Biomass_plot <- par_mort_eval_interval %>% 
  ggplot(aes(x = Param_val, y = Biomass)) +
  geom_line() + geom_point(size=.5) +
  theme_classic() + labs(x = "par_mort", y = "Biomass") + 
  ggtitle("Target variable: Biomass")

ggarrange(GPP_plot,LAI_plot,Density_plot,Biomass_plot, ncol = 2, nrow = 2)

```

