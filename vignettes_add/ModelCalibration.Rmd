---
title: "Model calibration"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(rsofun)
library(ggplot2)
```

### Simulation settings

Manually select some sites from which we're going to use the data for evaluation and calibration.
```{r}
mysites <- c("ORNL")
```

Create a site meta info table that contains all the site-specific information that is used to force site-simulations (e.g. starting year, number of simulations years, elevation, etc.). For FLUXNET2015 data, required meta info is provided by the `rsofun` package (data frame `rsofun::metainfo_Tier1_sites_kgclimate_fluxnet2015`).
```{r}
siteinfo <- data.frame(sitename="ORNL", lon = 0.0, lat = 0.0, elv = 0.0)
```

Now specify the simulation parameters that are identical for all site-scale simulations.
```{r}
params_siml <- list(
      spinup                = TRUE,
      spinupyears           = 1800, #1793,
      recycle               = 1, # 9 or 11
      firstyeartrend        = 1998,
      nyeartrend            = 1, #9 or 11 (longer transient years)
      outputhourly          = TRUE,
      outputdaily           = TRUE,
      do_U_shaped_mortality = FALSE,
      update_annualLAImax   = FALSE,
      do_closedN_run        = TRUE,
      method_photosynth     = "pmodel", # gs_leuning or pmodel
      method_mortality      = "dbh" # dbh or cstarvation or growthrate or const_selfthin
      )
```

### Define model parameters

#### Tile-level parameters

```{r}
params_tile <- list(
  soiltype     = 3,    # Sand = 1, LoamySand = 2, SandyLoam = 3, SiltLoam = 4, FrittedClay = 5, Loam = 6, Clay = 7
  FLDCAP       = 0.4,  # soil property: field capacity 
  WILTPT       = 0.05, # soil property: wilting point
  K1           = 2.0,  # turnover rate of fast SOM per year
  K2           = 0.1,  # turnover rate of slow SOM per year
  K_nitrogen   = 0.0,  # mineral Nitrogen turnover rate
  etaN         = 0.0,  # loss rate with runoff
  MLmixRatio   = 0.6,  # the ratio of C and N returned to litters from microbes
  l_fract      = 0.0,  # fraction of the carbon retained after leaf drop
  retransN     = 0.0,  # retranslocation coefficient of Nitrogen
  f_N_add      = 0.02, # re-fill of N for sapwood
  f_initialBSW = 0.005
  #LMAmin       = 0.02
  )

```

#### Species-level parameters

```{r}
params_species <- tibble(
  lifeform      = c(0,1,1,1,1,1,1,1,1,1,1),  # 0: grass; 1 Woody
  phenotype     = c(0,1,1,1,1,1,1,1,1,1,0),  # 0: Deciduous; 1 Evergreen
  pt            = c(1,0,0,0,0,0,0,0,0,0,0),  # 0: C3; 1: C4
  seedlingsize  = c(0.02,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05), # initial size of seedlings
  LMA           = c(0.035,0.14,0.14,0.14,0.14,0.14,0.14,0.14,0.14,0.14,0.035),
  # Leaf mass per unit area: 0.035, 0.085, 0.135
  phiRL         = c(4,4,2,3,4,5,6,7,8,9,3),
  # Root:Shoot ratio:  4.0, 6.0, 8.0
  LNbase        = c(0.8E-3,0.8E-3,0.8E-3,0.8E-3,0.8E-3,0.8E-3,0.8E-3,   0.8E-3,0.8E-3,0.8E-3,0.8E-3),   
  # kgN m-2 leaf, Vmax = 0.03125*LNbase
  laimax        = c(3.0,3.5,3.5,3.5,3.5,3.5,3.5,3.5,3.5,3.5,3.8),  
  # maximum crown LAI
  LAI_light     = c(3.0,3.5,3.5,3.5,3.5,3.5,3.5,3.5,3.5,3.5,3.8),  
  # Light-limited crown LAI
  Nfixrate0     = rep(0,11),  
  # 0.03 kgN kgRootC-1 yr-1
  NfixCost0     = rep(12,11),  
  # 12, 24 gC/gN
  phiCSA        = c(1.25E-4,0.25E-4,0.25E-4,0.25E-4,0.25E-4,0.25E-4,  0.25E-4,0.25E-4,0.25E-4,0.25E-4,0.25E-4),
  mortrate_d_c  = rep(0.02,11),    
  # canopy tree mortality rate, year-1
  mortrate_d_u  = c(0.2,0.08,0.08,0.08,0.08,0.08,0.08,0.08,0.08,0.08,0.08),   # understory tree mortality rate, year-1
  maturalage    = c(0.5,5,5,5,5,5,5,5,5,5,5),
  fNSNmax       = rep(5,11)
  #alpha_FR      = rep(1.2,11)
  ) %>% 
  bind_rows(., slice(., 1:5))
```

#### Soil parameters

By layers.
```{r}
# adopted from datatypes.mod.f90 l.538
params_soil <- tibble(
  type              = c("Coarse","Medium","Fine","CM","CF","MF","CMF","Peat","MCM"),
  GMD               = c(0.7, 0.4, 0.3, 0.1, 0.1, 0.07, 0.007, 0.3, 0.3),
  GSD               = c(5.0, 5.3, 7.4, 6.1, 6.1, 14.0, 15.0, 7.4, 7.4),
  vwc_sat           = c(0.380, 0.445, 0.448, 0.412, 0.414, 0.446, 0.424, 0.445, 0.445),
  chb               = c(3.5,6.4,11.0,4.8,6.3,8.4,6.3,6.4,6.4),
  psi_sat_ref       = c(-600, -790, -910, -1580, -1680, -1880, -5980, -790, -790), # Pa
  k_sat_ref         = c(130.8, 75.1, 53.2, 12.1, 11.1, 12.7, 1.69, 53.2, 53.2), # mol/(s MPa m)
  alphaSoil         = rep(1, 9),
  heat_capacity_dry = c(1.2e6, 1.1e6, 1.1e6, 1.1e6, 1.1e6, 1.1e6, 1.1e6, 1.4e6, 1.0)
  )
```

#### Initial cohort specification

```{r}
init_cohort <- tibble(
 init_cohort_species = seq(1, 10, 1),
 init_cohort_nindivs = rep(0.02,10),
 init_cohort_bsw     = rep(0.2,10),
 init_cohort_bHW     = rep(0.10),
 init_cohort_nsc     = rep(0.5,10)
)
```

#### Initial soil pools

```{r}
# high N input --> Deciduous
# low  N input --> Evergreen
init_soil <- list(
 init_fast_soil_C    = 0.15,   # kg C m-2    # C/N = 15, 0.75 kg SOM ~ 50 gN
 init_slow_soil_C    = 16.0,   # kg C m-2    # C/N = 40
 init_Nmineral       = 2.5E-3, # kg N m-2
 N_input             = 0.0E-3  # 2.4E-3, # kg N m-2 yr-1, N deposit: 0.8 g N m-2 yr-1
)
```

### Define soil parameters

For now, this is implemented as an illustration. Should be made site-specific.
```{r}
df_soiltexture <- bind_rows(
  top    = tibble(layer = "top", fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1),
  bottom = tibble(layer = "bottom", fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1)
)
```

### Get input

```{r}
forcing <- read_delim( paste0(path.package("rsofun"), "/extdata/ORNL_forcing.txt"), col_names = TRUE, delim = "\t") %>% 
  mutate(date = lubridate::ymd_hm( paste0( as.character(YEAR), "-01-01 00:00" ) ) + days(DOY-1) + hours(HOUR) ) %>% 
  mutate(sitename = "ORNL") %>% 
  dplyr::filter(!(mday(date)==29 & month(date)==2))

## convert rain to units per seconds
dt_secs <- lubridate::interval(forcing$date[1], forcing$date[2]) %>% 
  time_length("seconds")
forcing <- forcing %>% 
  mutate(RAIN = RAIN / dt_secs)

if (params_siml$method_photosynth == "gs_leuning"){
  forcing <- forcing %>% 
    dplyr::group_by(lubridate::month(date),lubridate::day(date),lubridate::hour(date)) %>% 
    summarise_at(vars(1:13), list(~mean(., na.rm = TRUE)))
  forcing <- forcing[,-c(1:3)]
}

```

For P-model runs, aggregate to daily forcing.
```{r}
if (params_siml$method_photosynth == "pmodel" && dt_secs != (60*60*24)){
#  forcing <- forcing %>% 
#    dplyr::group_by(lubridate::date(date)) %>% 
#    summarise_at(vars(1:13), list(~mean(., na.rm = TRUE))) %>% 
#    dplyr::select(-1)
  forcing <- forcing %>% 
    dplyr::group_by(lubridate::month(date),lubridate::day(date)) %>% 
    summarise_at(vars(1:13), list(~mean(., na.rm = TRUE)))
  forcing <- forcing[,-c(1:2)]
}

# Changing values of PAR for running simulations
#forcing <- forcing %>% mutate(PAR = PAR*1.30) # levels = *1, *1.15 and *1.30

# Replicating forcing data to run longer transient years
#forcing <- bind_rows(replicate(10, forcing, simplify = FALSE))

```

### Run the model for different cases

Run the model for all environmental conditions, species and mortality formulations.
```{r}
out <- run_lm3ppa_f_bysite( "ORNL", 
                            params_siml, 
                            siteinfo, 
                            forcing, # ddf_input
                            params_tile, 
                            params_species, 
                            params_soil, 
                            init_cohort, 
                            init_soil, 
                            makecheck = TRUE)

out$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = GPP)) +
  labs(title = "LM3-PPA with gs-leuning photosynthesis at ORNL", subtitle = "rsofun output")

out$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = plantC)) +
  labs(title = "LM3-PPA with gs-leuning photosynthesis at ORNL", subtitle = "rsofun output")

out$output_annual_tile %>% 
  ggplot() + geom_line(aes(x = year, y = DBH12)) +
  theme_classic()+labs(x = "Year", y = "DBH")

out$output_annual_tile %>% 
  ggplot() + geom_line(aes(x = year, y = Density12)) +
  theme_classic()+labs(x = "Year", y = "Density")

out$output_annual_tile %>% 
  ggplot() + geom_line(aes(x = year, y = CAI)) +
  theme_classic()+labs(x = "Year", y = "CAI")

```

### Calibration

#### Data for calibration

GPP data from FluxNet (see Euler)
FLX_CH-Lae_FLUXNET2015_FULLSET_YY_2004-2014_1-3.csv
Variable: GPP_NT_VUT_REF

```{r}
Fluxnet <- read.csv("FLX_CH-Lae_FLUXNET2015_FULLSET_YY_2004-2014_1-3.csv")
GPP <- Fluxnet[,c("TIMESTAMP","GPP_NT_VUT_REF")]
mean_annual_gpp <- mean(GPP$GPP_NT_VUT_REF)
```

Biomass data from LWF data from Laegeren (provided by Christoph Bachofen, need to ask Flurin Sutter)
Variables: BHD is DBH and 
Site: LAE
LNR_ID: Number of trees #664
BA:
Map_ID
RETICB
Subsite
ARTN.TEXT
BHD: DBH (cm)
HOEHE: Height(m)

Biomass 
See book Swiss national forest inventory: methods and models of the fourth assessment. Chapter 12-14.\
See equation 12.6 to estimate Stem Volume for Fagus sylvatica. V is the stem volume over bark (in m3), diameter at breast height (in m) and h is the total tree height (in m).
0.0025428 0.39446 2.56612 -3.67034 0.03567
Wood density Fagus sylvatica: 560 kgm3

```{r}
LAE_alltrees <- read.csv("LAE_alltrees.csv")
unique(LAE_alltrees$ARTN.TEXT)

LAE_Fagus <- LAE_alltrees %>% filter(ARTN.TEXT == "Fagus sylvatica")
LAE_Fagus <- LAE_Fagus %>% mutate(DBH_m = BHD/100) %>% mutate(StemVolume = 0.0025428 + 0.39446*DBH_m*DBH_m*HOEHE + 2.56612*DBH_m*DBH_m - 3.67034*DBH_m*DBH_m*DBH_m + 0.03567*DBH_m*DBH_m*DBH_m*HOEHE) %>% mutate(StemBiomass = StemVolume * 560)
mean_biomass <- mean(LAE_Fagus$StemBiomass)

```

Specific leaf area (SLA) is the ratio of leaf area to leaf dry mass.
Leaf Mass per Area (LMA) is the inverse of SLA.

LAI or fAPAr from MODIS

```{r}
fapar_LAE <- read.csv("fapar_MODIS_FPAR_MCD15A3H_gee_CH-Lae_subset.csv")
mean_annual_fapar <- mean(fapar_LAE$modisvar, na.rm=T)
```

## Number of trees higher than 12 cm 

```{r}
LAE_alltrees <- read.csv("LAE_alltrees.csv")
unique(LAE_alltrees$ARTN.TEXT)

LAE_Fagus <- LAE_alltrees %>% filter(ARTN.TEXT == "Fagus sylvatica")
LAE_Fagus <- LAE_Fagus %>% mutate(DBH_m = BHD/100) %>% mutate(StemVolume = 0.0025428 + 0.39446*DBH_m*DBH_m*HOEHE + 2.56612*DBH_m*DBH_m - 3.67034*DBH_m*DBH_m*DBH_m + 0.03567*DBH_m*DBH_m*DBH_m*HOEHE) %>% mutate(StemBiomass = StemVolume * 560)
mean_biomass <- mean(LAE_Fagus$StemBiomass)

```

Define calibration settings.
Targets: GPP, LAI, Stand Biomass (Stem, Foliage, root), Stand density or # trees
Calibration parameters: Quantum Yield Efficiency, Specific Leaf Area, Root:Shoot allocation, Resp rates (sapwood and fine roots)

```{r}
settings_calib <- list(
  method              = "gensa", # gensa, optimr, BayesianTools, linscale
  targetvars          = c("GPP","AGB","LAI","NPP"),
  timescale           = list( GPP = "d" ),
  maxit               = 5, # (5 for gensa) (30 for optimr)
  sitenames           = "CH-Lae",
  metric              = "rmse",
  dir_results         = "./",
  name                = "ORG",
  par                 = list( kphio = list( lower=0.02, upper=0.07, init=0.0496 ) )
 )
```

Collect calibration target data: GPP, LAI, Stand Biomass (Stem, Foliage, root), Stand density or # trees

```{r}
# Read target data

```

Calibrate the model

```{r}
set.seed(1982)
settings_calib <- calib_sofun(
  df_drivers = dplyr::filter(df_drivers, sitename %in% settings_calib$sitenames),  # use only one site
  ddf_obs = , # Read target data
  settings = settings_calib
  )
```

The calibrated parameters are returned by calib_sofun() as part of the list:
```{r}
print(settings_calib$par_opt)
```


