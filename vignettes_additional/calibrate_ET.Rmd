---
title: "Calibrate ET"
author: "Beni Stocker"
date: "`r Sys.Date()`"
# output:
#   html_document:
#     toc: true
#     toc_float: true
#     toc_depth: 4
#     number_sections: true
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
header-includes:
   - \usepackage{amsmath}
bibliography: bibliography.bib
---

## Rationale

```{r setup, include=FALSE}
library(rsofun)
load_dependencies_rsofun()
systr <- "''"    # for Mac
options( list( rsofun.dir.sofun="~/sofun/trunk/" ))
```

ET is simulated for the MCT-zroot study as:
$$
ET = a\; \text{fAPAR} \; \text{PET} \; G_s(D)
$$

Where the function $G_s(D)$ is taken from Oren et al. (2001) as
$$
G_s(D) = b + m \ln(D)
$$
This requires three additional model parameters for SPLASH/SOFUN: $a, b, m$.

```{r}
a <- 1
b <- 0.1
m <- 0.2

# from calibration at US-Ha1:
a <- 0.1
b <- 3.841307
m <- 1.368163
calc_vpd_stress <- function(vpd, a, b, m){
  out <- a * (b - m * (log(0.001) + log(vpd)))
  out <- ifelse(out>1, 1, out)
  out <- ifelse(out<0, 0, out)
  return(out)
}
df <- tibble(
  x = seq(0, 2000, by = 20)
  ) %>% 
  mutate(y = calc_vpd_stress(x, a, b, m) )

data.frame(x = c(0, 2000)) %>% 
ggplot(aes(x = x)) +
        stat_function(fun = calc_vpd_stress, args = list(a=a, b=b, m=m)) +
  lims(y=c(0, 1)) +
  geom_point(data = df, aes(x, y)) +
  labs(x = "VPD (Pa)", y = "Stress factor")
```

## Using rsofun

### General settings

```{r message=FALSE}
path_siteinfo <- "/alphadata01/bstocker/rsofun/siteinfo_pet_fluxnet2015.csv"
siteinfo <- rsofun::metainfo_Tier1_sites_kgclimate_fluxnet2015 %>% 
  dplyr::filter(sitename == "US-Ha1") %>%    # xxx debug
  write_csv(path = path_siteinfo)

settings_sims <- list(
  siteinfo        = path_siteinfo,
  ensemble        = TRUE,
  setup           = "site",
  name            = "calib_et_fluxnet2015",
  dir_sofun       = "/alphadata01/bstocker/sofun/trunk/",
  path_output     = "~/sofun/output_pet_fluxnet2015_sofun/",
  path_output_nc  = "~/sofun/output_nc_pet_fluxnet2015_sofun/",
  path_input      = "~/sofun/input_pet_fluxnet2015_sofun/",
  grid            = NA,
  implementation  = "fortran",
  soilmstress     = TRUE,
  tempstress      = TRUE,
  in_ppfd         = TRUE,
  in_netrad       = FALSE,
  recycle         = 1,
  spinupyears     = 10,
  calibvars       = c("latenth")
  )

settings_input <-  list(
  data                     = NA,
  temperature              = "fluxnet2015",
  precipitation            = "fluxnet2015",
  vpd                      = "fluxnet2015",
  ppfd                     = "fluxnet2015",
  netrad                   = "fluxnet2015",  #  c("fluxnet2015", "watch_wfdei"),
  patm                     = "fluxnet2015",
  cloudcover               = "cru",
  fapar                    = "MODIS_EVI_MOD13Q1", #  "MODIS_FPAR_MCD15A3H", # "",
  splined_fapar            = TRUE,
  path_co2                 = "~/data/co2/cCO2_rcp85_const850-1765.dat",
  path_fluxnet2015         = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1d/original/unpacked/",
  path_fluxnet2015_hh      = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_0.5h/original/unpacked/",
  path_MODIS_FPAR_MCD15A3H = "~/data/fapar_MODIS_FPAR_MCD15A3H_gee_MCD15A3H_fluxnet2015_gee_subset/",
  path_MODIS_EVI_MOD13Q1   = "~/data/fapar_MODIS_EVI_MOD13Q1_gee_MOD13Q1_fluxnet2015_gee_subset/",
  get_from_remote          = FALSE,
  path_cru                 = "~/data/cru/ts_4.01/",
  settings_gee             = get_settings_gee( 
    bundle = "fpar", 
    python_path = "/Users/benjaminstocker/Library/Enthought/Canopy_64bit/User/bin/python",
    gee_path = "/alphadata01/bstocker/gee_subset/gee_subset/"
    )
  )

setup_sofun <- list(
  model      = "pmodel",
  dir        = "~/sofun/trunk",
  do_compile = FALSE,
  simsuite   = FALSE
  )
```

### Calibration settings
```{r}
## Use only sites for calibration for which ANN method by Stocker et al. (2018) worked fine,
## and exclude sites where C4 vegetation is present.
c4sites <- siteinfo %>% 
  dplyr::filter(c4) %>% 
  pull(sitename)
calibsites <- readr::read_csv( "~/data/flue/flue_stocker18nphyt.csv" ) %>%
              dplyr::select(site, cluster) %>% 
              dplyr::distinct() %>% 
              dplyr::filter( !is.na(cluster) ) %>%
              dplyr::filter( !(site %in% c4sites) ) %>%  # additionally exclude C4
              dplyr::pull(site)

## xxx debug:
calibsites <- "US-Ha1"

# ## crude fix: exclude DE-Akm from calibration sites because there's no fapar data available
# calibsites <- calibsites[-which(calibsites %in% c("DE-Akm", "FI-Sod", "IT-Ro1"))]

settings_calib <- list(
  name             = "calib_et",
  par              = list( apar_latenth = list( lower=0.1,  upper=2.0,  init=1.0 ),
                           bpar_latenth = list( lower=0.01, upper=20.0, init=0.1 ),
                           mpar_latenth = list( lower=0.01, upper=20.0, init=0.2 ) ),
  method           = "gensa",
  targetvars       = c("latenth"),
  datasource       = list( latenth = "fluxnet2015" ),
  timescale        = list( latenth = "d" ),
  path_fluxnet2015 = "~/data/FLUXNET-2015_Tier1/20160128/point-scale_none_1d/original/unpacked/",
  maxit            = 30,
  sitenames        = calibsites,
  filter_temp_min  = NA,
  filter_temp_max  = NA,
  filter_soilm_min = NA,
  filter_drought   = FALSE,
  metric           = "rmse",
  dir_results      = "~/mct/calib_results/"
 )
```


### Prepare setup
```{r}
settings_sims <- prepare_setup_sofun(
  settings = settings_sims,
  setup = setup_sofun,
  settings_calib = settings_calib,
  write_paramfils = TRUE
  )
```


### Prepare inputs
```{r, eval=TRUE, message=FALSE, warning=TRUE, results="hide"}
inputdata <- prepare_input_sofun(
  settings_input = settings_input,
  settings_sims = settings_sims,
  return_data = FALSE,
  overwrite_climate = TRUE,
  overwrite_fapar = FALSE,
  verbose = TRUE,
  overwrite_csv_climate = TRUE,
  overwrite_csv_fapar = FALSE
  )
```


# VPD-stress calibration

Calibration is done for all good-quality sites and all parameters at once.

```{r, message=FALSE, include=FALSE}
## Get observational data (GPP based on NT method) used as target for calibration
filn <- "~/mct/data/ddf_obs.Rdata"
if (!exists("ddf_obs") && file.exists(filn)){
  load(filn)
} else {
  if (!exists("ddf_obs")){
    ddf_obs <- get_obs_calib( settings_calib, settings_sims, settings_input )
    save( ddf_obs, file =  )
  }
}

set.seed(1982)
settings_calib <- calib_sofun(
  setup          = setup_sofun,
  settings_calib = settings_calib,
  settings_sims  = settings_sims,
  settings_input = settings_input,
  ddf_obs        = ddf_obs
  )

## update parameters for site-level simulations, run and read sofun
params_opt <- readr::read_csv( paste0("params_opt_", settings_calib$name,".csv") )
nothing <- update_params( params_opt, settings = settings_sims )
rm("mod")
mod <- runread_sofun( 
  settings = settings_sims, 
  setup = setup_sofun 
  )
save( mod, file="mod.Rdata" )
```

Head over to `eval_sofun.Rmd` and knit it. Save settings to files in order to read them in by eval_sofun.
```{r, eval=TRUE, message=FALSE, warning=FALSE}
save( settings_eval, file = "settings_eval.Rdata" )
save( settings_sims, file = "settings_sims.Rdata" )
save( siteinfo, file = "siteinfo.Rdata" )
```
